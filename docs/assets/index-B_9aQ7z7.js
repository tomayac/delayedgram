(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const r of e.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function a(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function o(t){if(t.ep)return;t.ep=!0;const e=a(t);fetch(t.href,e)}})();const s=document.getElementById("video"),w=document.getElementById("photos"),h=document.getElementById("capture"),n=document.getElementById("canvas"),g=n.getContext("2d",{willReadFrequently:!0});let y=!1;const d={invert:null,grayscale:null},v=async(m,i)=>{performance.mark("draw-start");const a=m.split(`
`),o=parseInt(a[1].split(" ")[0],10),t=parseInt(a[1].split(" ")[1],10),e=a.splice(3).join(`
`).split(" ").map(c=>parseInt(c,10)),r=new ImageData(o,t);for(let c=0,u=0;c<e.length;c+=3)r.data[u+0]=e[c+0],r.data[u+1]=e[c+1],r.data[u+2]=e[c+2],r.data[u+3]=255,u+=4;const p=await createImageBitmap(r),l=document.createElement("canvas");l.width=o,l.height=t,l.getContext("2d").drawImage(p,0,0),w.append(l),performance.mark("draw-end"),performance.measure(`Draw ${i} image`,"draw-start","draw-end")};async function I(){return new Promise(async(m,i)=>{try{const a={video:{facingMode:"user",width:{ideal:640},height:{ideal:480}}},o=await navigator.mediaDevices.getUserMedia(a);s.addEventListener("canplay",()=>{if(!y){const t=s.videoHeight,e=s.videoWidth;s.width=e,s.height=t,n.width=e,n.height=t,g.translate(e,0),g.scale(-1,1),y=!0}m()}),s.srcObject=o}catch(a){i(a)}})}h.addEventListener("click",async()=>{if(w.innerHTML="",!s.srcObject)try{await I();return}catch(e){console.error("Error accessing camera:",e),alert(`Error accessing camera: ${e}`);return}h.classList.add("busy"),performance.mark("ppm-start"),n.width=s.videoWidth,n.height=s.videoHeight,g.drawImage(s,0,0,n.width,n.height);const m=g.getImageData(0,0,n.width,n.height),i=`P3
${n.width} ${n.height}
255
`,a=Array.from(m.data).reduce((e,r,p)=>((p+1)%4!==0&&(e+=`${r} `),e),""),o=`${i}${a}`;performance.mark("ppm-end"),performance.measure("Prepare webcam image","ppm-start","ppm-end");let t=0;performance.mark("filters-start");for(const[e,r]of Object.entries(d))r&&(r.terminate(),d[e]=null),d[e]=new Worker(new URL("/delayedgram/assets/filter-worker-DYBW_e1m.js",import.meta.url),{type:"module"}),d[e].addEventListener("message",async p=>{t+=1;const{ppmP3String:l}=p.data;await v(l,"invert"),t===2&&(performance.mark("filters-end"),performance.measure("Apply filters","filters-start","filters-end"),t=0,h.classList.remove("busy"),performance.getEntriesByType("measure").forEach(f=>{console.log(f.name,f.duration.toFixed(0))})),d[e].terminate(),d[e]=null}),d[e].postMessage({ppmP3String:o,filter:e})});
